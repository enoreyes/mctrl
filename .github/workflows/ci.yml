name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  lint:
    name: Lint & Typecheck
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: npm
      - run: npm ci
      - run: npm run lint

  test-unit-cross-platform:
    name: Unit Tests (cross-platform)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: npm
      - run: npm ci
      - run: npx vitest run tests/unit/cli.test.ts tests/unit/files.test.ts tests/unit/keyboard.test.ts tests/unit/browser.test.ts

  test-macos:
    name: Tests (macOS)
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: npm

      - name: Grant TCC permissions for AppleScript and Accessibility
        run: |
          SYSTEM_DB="/Library/Application Support/com.apple.TCC/TCC.db"
          USER_DB="$HOME/Library/Application Support/com.apple.TCC/TCC.db"

          # Detect column count in TCC.db access table
          COLS=$(sudo sqlite3 "$SYSTEM_DB" "pragma table_info(access);" | wc -l | tr -d ' ')
          echo "TCC access table has $COLS columns"

          # Build suffix for extra columns (macOS 14+ has 17 columns vs 13)
          if [ "$COLS" -gt 13 ]; then
            SUFFIX=",NULL,NULL,'UNUSED',1592919552"
          else
            SUFFIX=""
          fi

          # Grant Accessibility (system DB)
          sudo sqlite3 "$SYSTEM_DB" \
            "INSERT OR REPLACE INTO access VALUES('kTCCServiceAccessibility','com.apple.Terminal',0,2,0,1,NULL,NULL,NULL,'UNUSED',NULL,0,1592919552${SUFFIX});"
          sudo sqlite3 "$SYSTEM_DB" \
            "INSERT OR REPLACE INTO access VALUES('kTCCServiceAccessibility','/usr/bin/osascript',1,2,0,1,NULL,NULL,NULL,'UNUSED',NULL,0,1592919552${SUFFIX});"
          sudo sqlite3 "$SYSTEM_DB" \
            "INSERT OR REPLACE INTO access VALUES('kTCCServiceAccessibility','/bin/bash',1,2,0,1,NULL,NULL,NULL,'UNUSED',NULL,0,1592919552${SUFFIX});"

          # Grant Screen Capture (system DB)
          sudo sqlite3 "$SYSTEM_DB" \
            "INSERT OR REPLACE INTO access VALUES('kTCCServiceScreenCapture','/usr/bin/osascript',1,2,0,1,NULL,NULL,NULL,'UNUSED',NULL,0,1592919552${SUFFIX});"
          sudo sqlite3 "$SYSTEM_DB" \
            "INSERT OR REPLACE INTO access VALUES('kTCCServiceScreenCapture','com.apple.Terminal',0,2,0,1,NULL,NULL,NULL,'UNUSED',NULL,0,1592919552${SUFFIX});"
          sudo sqlite3 "$SYSTEM_DB" \
            "INSERT OR REPLACE INTO access VALUES('kTCCServiceScreenCapture','/bin/bash',1,2,0,1,NULL,NULL,NULL,'UNUSED',NULL,0,1592919552${SUFFIX});"

          # Grant Apple Events to System Events (user DB)
          sudo sqlite3 "$USER_DB" \
            "INSERT OR REPLACE INTO access VALUES('kTCCServiceAppleEvents','/usr/bin/osascript',1,2,0,1,NULL,NULL,0,'com.apple.systemevents',NULL,NULL,1592919552${SUFFIX});"
          sudo sqlite3 "$USER_DB" \
            "INSERT OR REPLACE INTO access VALUES('kTCCServiceAppleEvents','/bin/bash',1,2,0,1,NULL,NULL,0,'com.apple.systemevents',NULL,NULL,1592919552${SUFFIX});"
          sudo sqlite3 "$USER_DB" \
            "INSERT OR REPLACE INTO access VALUES('kTCCServiceAppleEvents','com.apple.Terminal',0,2,0,1,X'fade0c000000003000000001000000060000000200000012636f6d2e6170706c652e5465726d696e616c000000000003',NULL,0,'com.apple.systemevents',X'fade0c000000003400000001000000060000000200000016636f6d2e6170706c652e73797374656d6576656e7473000000000003',NULL,1592919552${SUFFIX});"

          # Grant Apple Events to Finder (user DB)
          sudo sqlite3 "$USER_DB" \
            "INSERT OR REPLACE INTO access VALUES('kTCCServiceAppleEvents','/usr/bin/osascript',1,2,0,1,NULL,NULL,0,'com.apple.finder',NULL,NULL,1592919552${SUFFIX});"
          sudo sqlite3 "$USER_DB" \
            "INSERT OR REPLACE INTO access VALUES('kTCCServiceAppleEvents','/bin/bash',1,2,0,1,NULL,NULL,0,'com.apple.finder',NULL,NULL,1592919552${SUFFIX});"

          # Grant Accessibility (user DB)
          sudo sqlite3 "$USER_DB" \
            "INSERT OR REPLACE INTO access VALUES('kTCCServiceAccessibility','com.apple.Terminal',0,2,0,1,X'fade0c000000003000000001000000060000000200000012636f6d2e6170706c652e5465726d696e616c000000000003',NULL,NULL,'UNUSED',NULL,0,1592919552${SUFFIX});"
          sudo sqlite3 "$USER_DB" \
            "INSERT OR REPLACE INTO access VALUES('kTCCServiceAccessibility','/usr/bin/osascript',1,2,0,1,NULL,NULL,NULL,'UNUSED',NULL,0,1592919552${SUFFIX});"
          sudo sqlite3 "$USER_DB" \
            "INSERT OR REPLACE INTO access VALUES('kTCCServiceAccessibility','/bin/bash',1,2,0,1,NULL,NULL,NULL,'UNUSED',NULL,0,1592919552${SUFFIX});"

          # Grant Screen Capture (user DB)
          sudo sqlite3 "$USER_DB" \
            "INSERT OR REPLACE INTO access VALUES('kTCCServiceScreenCapture','/usr/bin/osascript',1,2,0,1,NULL,NULL,NULL,'UNUSED',NULL,0,1592919552${SUFFIX});"
          sudo sqlite3 "$USER_DB" \
            "INSERT OR REPLACE INTO access VALUES('kTCCServiceScreenCapture','com.apple.Terminal',0,2,0,1,NULL,NULL,NULL,'UNUSED',NULL,0,1592919552${SUFFIX});"
          sudo sqlite3 "$USER_DB" \
            "INSERT OR REPLACE INTO access VALUES('kTCCServiceScreenCapture','/bin/bash',1,2,0,1,NULL,NULL,NULL,'UNUSED',NULL,0,1592919552${SUFFIX});"

          echo "TCC permissions granted successfully"

      - name: Install Python Quartz bindings
        run: pip3 install --break-system-packages pyobjc-framework-Quartz

      - run: npm ci
      - name: Run all tests
        run: npm test
