name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  lint:
    name: Lint & Typecheck
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: npm
      - run: npm ci
      - run: npm run lint

  test-unit-cross-platform:
    name: Unit Tests (cross-platform)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: npm
      - run: npm ci
      - run: npx vitest run tests/unit/cli.test.ts tests/unit/files.test.ts tests/unit/keyboard.test.ts tests/unit/browser.test.ts

  test-macos:
    name: Tests (macOS)
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: npm

      - name: Grant TCC permissions for AppleScript and Accessibility
        run: |
          # Grant Accessibility access
          sudo sqlite3 /Library/Application\ Support/com.apple.TCC/TCC.db \
            "INSERT OR REPLACE INTO access VALUES('kTCCServiceAccessibility','com.apple.Terminal',0,2,4,1,NULL,NULL,0,'UNUSED',NULL,0,1592919552);"
          sudo sqlite3 /Library/Application\ Support/com.apple.TCC/TCC.db \
            "INSERT OR REPLACE INTO access VALUES('kTCCServiceAccessibility','/usr/bin/osascript',1,2,4,1,NULL,NULL,0,'UNUSED',NULL,0,1592919552);"
          sudo sqlite3 /Library/Application\ Support/com.apple.TCC/TCC.db \
            "INSERT OR REPLACE INTO access VALUES('kTCCServiceAccessibility','/usr/local/opt/runner/provisioner/provisioner',1,2,4,1,NULL,NULL,0,'UNUSED',NULL,0,1592919552);"
          # Grant Apple Events for System Events
          sudo sqlite3 "$HOME/Library/Application Support/com.apple.TCC/TCC.db" \
            "INSERT OR REPLACE INTO access VALUES('kTCCServiceAppleEvents','/usr/bin/osascript',1,2,3,1,NULL,NULL,0,'com.apple.systemevents',X'fade0c000000003400000001000000060000000200000016636f6d2e6170706c652e73797374656d6576656e7473000000000003',NULL,1592919552);"
          sudo sqlite3 /Library/Application\ Support/com.apple.TCC/TCC.db \
            "INSERT OR REPLACE INTO access VALUES('kTCCServiceAppleEvents','/usr/local/opt/runner/provisioner/provisioner',1,2,3,1,NULL,NULL,0,'com.apple.systemevents',X'fade0c000000003400000001000000060000000200000016636f6d2e6170706c652e73797374656d6576656e7473000000000003',NULL,1592919552);"
          # Grant Apple Events for Finder
          sudo sqlite3 "$HOME/Library/Application Support/com.apple.TCC/TCC.db" \
            "INSERT OR REPLACE INTO access VALUES('kTCCServiceAppleEvents','/usr/bin/osascript',1,2,3,1,NULL,NULL,0,'com.apple.finder',X'fade0c000000002c00000001000000060000000200000010636f6d2e6170706c652e66696e64657200000003',NULL,1592919552);"
          sudo sqlite3 /Library/Application\ Support/com.apple.TCC/TCC.db \
            "INSERT OR REPLACE INTO access VALUES('kTCCServiceAppleEvents','/usr/local/opt/runner/provisioner/provisioner',1,2,3,1,NULL,NULL,0,'com.apple.finder',X'fade0c000000002c00000001000000060000000200000010636f6d2e6170706c652e66696e64657200000003',NULL,1592919552);"

      - run: npm ci
      - name: Run all tests
        run: npm test
